<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English 5 Speaking ‚Äì Hoa Khuong 2</title>
    <style>
        :root { --primary: #1565c0; --green: #27ae60; --coral: #FF7F50; --bg: #f0f7ff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: "Comic Sans MS", "Lexend", cursive, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        
        .container { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: var(--primary); margin: 5px 0; }
        h2 { font-size: 0.9rem; color: #666; margin-bottom: 15px; }

        .card { background: #f9fbff; padding: 15px; border-radius: 20px; margin-bottom: 15px; border: 2px dashed #bbdefb; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 15px; border: 2px solid #e3f2fd; font-size: 16px; margin-top: 8px; font-family: inherit; }
        
        .unit-title { background: #ffeb3b; padding: 10px; border-radius: 50px; text-align: center; font-weight: bold; margin-bottom: 10px; color: #333; }
        .sample-box { background: #fff; padding: 15px; border-radius: 15px; border-left: 5px solid var(--green); line-height: 1.6; font-size: 1.1rem; }

        .btn-record { background: linear-gradient(135deg, var(--primary), #6c5ce7); color: white; border: none; padding: 18px; border-radius: 50px; font-size: 1.2rem; font-weight: bold; width: 100%; cursor: pointer; box-shadow: 0 8px 15px rgba(21, 101, 192, 0.3); transition: 0.3s; }
        .btn-record.recording { background: #e74c3c; animation: pulse 1.5s infinite; }
        .btn-listen { background: #E3F2FD; color: var(--primary); border: 2px solid var(--primary); padding: 8px 15px; border-radius: 50px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* Ch·ªØ xanh (ƒë√∫ng) - Ch·ªØ Cam Coral (sai) */
        .word-correct { color: var(--green); font-weight: bold; cursor: pointer; }
        .word-error { color: var(--coral); font-weight: bold; text-decoration: underline; cursor: pointer; }
        
        .ai-feedback-box { background: #fff; border: 2px solid #eee; padding: 15px; border-radius: 15px; margin-top: 10px; }
        .grammar-fix { background: #fff3e0; border-left: 5px solid var(--coral); padding: 10px; margin-top: 10px; border-radius: 8px; font-size: 0.95rem; }

        .certificate { display: none; margin-top: 30px; padding: 30px 15px; border: 8px double #fbc02d; background: #fff; text-align: center; border-radius: 25px; }
        .cert-name { font-size: 2rem; color: #6c5ce7; margin: 10px 0; font-weight: bold; }
        .sign-box { display: flex; justify-content: space-around; margin-top: 40px; font-size: 0.8rem; line-height: 1.4; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h1>üé§ English 5 Speaking</h1>
    <h2>Hoa Khuong 2 Primary School</h2>

    <div class="card">
        <div style="display:flex; gap:10px">
            <input id="studentName" placeholder="Student name...">
            <input id="studentClass" placeholder="Class (e.g. 5/1)">
        </div>
        <select id="mode">
            <option value="unit">Practice by Unit</option>
            <option value="free">Free Speaking AI</option>
        </select>
    </div>

    <div id="unitCard" class="card">
        <select id="unitSel" onchange="updateUnit()"></select>
        <div class="unit-title" id="unitTitle">Unit 1</div>
        <div class="sample-box" id="sampleText"></div>
        <button class="btn-listen" onclick="speakNow(document.getElementById('sampleText').innerText)">üîä Listen Sample</button>
    </div>

    <div class="card">
        <textarea id="studentText" rows="3" placeholder="Tap Start and speak..."></textarea>
        <button id="recBtn" class="btn-record" onclick="toggleRec()">üéô START SPEAKING</button>
    </div>

    <div id="feedbackCard" class="card" style="display:none">
        <h3 style="margin-top:0">ü§ñ AI Teacher Feedback</h3>
        <div id="wordFeedback"></div>
        <div id="grammarFeedback"></div>
        <div id="starBox" style="font-size:30px; text-align:center; margin-top:10px"></div>
    </div>

    <div class="certificate" id="certificate">
        <div style="font-weight:bold; color:var(--primary)">HOA KHUONG 2 PRIMARY SCHOOL</div>
        <div style="font-size:1.5rem; margin:15px 0; color:#b8860b">CERTIFICATE OF SPEAKING</div>
        <p>Proudly presented to</p>
        <div class="cert-name" id="cName">...</div>
        <p id="cClassAndUnit"></p>
        <div style="font-size:3rem" id="cStar">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
        <div class="sign-box">
            <div><b>Principal</b><br><br>Tran Thi Kim Yen</div>
            <div><b>Teacher</b><br><br>Pham Thi Ngoc Bich</div>
        </div>
    </div>
</div>

<audio id="clap" src="https://www.soundjay.com/human/applause-8.mp3"></audio>

<script>
// --- D·ªÆ LI·ªÜU 20 UNIT CHI TI·∫æT THEO T√ÄI LI·ªÜU ---
const units = {
    1: ["Unit 1: All about me", "I‚Äôm Hoang. I‚Äôm in class 5/3. I live in the countryside. My favourite colour is yellow. My favourite animal is a dolphin. My favourite food is a sandwich. My favourite sport is table tennis."],
    2: ["Unit 2: Our homes", "I live in a flat. My address is 65 Le Loi Street. It is a big and modern building in the city. I love my home."],
    3: ["Unit 3: My foreign friends", "My friend is from Australia. He is friendly and helpful. He is active and clever."],
    4: ["Unit 4: Our free-time activities", "In my free time, I go for a walk and water the flowers. I like surfing the Internet."],
    5: ["Unit 5: My future job", "I‚Äôd like to be a teacher because I‚Äôd like to teach children. My brother wants to be a doctor."],
    6: ["Unit 6: Our school rooms", "The computer room is on the second floor. Go upstairs and turn right. The library is very big."],
    7: ["Unit 7: School activities", "I like doing projects because it is interesting. My favourite activity is singing English songs."],
    8: ["Unit 8: In our classroom", "The board is in front of the class. The clock is above the door. The crayons are on the table."],
    9: ["Unit 9: Outdoor activities", "Yesterday, we went camping and danced around the campfire. We watched the fish."],
    10: ["Unit 10: Our school trip", "We visited Ba Na Hills and took many photos. It was a fantastic trip last weekend."],
    11: ["Unit 11: Family time", "Last weekend, my family went to the beach. We took a boat trip around the bay."],
    12: ["Unit 12: Our Tet holiday", "At Tet, we decorate the house and visit our relatives. I get lucky money."],
    13: ["Unit 13: Our special days", "On Children's Day, we have fun and get lovely gifts. We eat pizza and drink milk tea."],
    14: ["Unit 14: Staying healthy", "I eat healthy food and exercise three times a week. I go for a walk in the park."],
    15: ["Unit 15: Our health", "I have a sore throat. I should drink warm water. I shouldn't eat ice cream."],
    16: ["Unit 16: Seasons and weather", "It is cloudy in autumn and cold in winter. It is hot and sunny in summer."],
    17: ["Unit 17: Stories for children", "The story is about a clever fox and a greedy crow. Snow White and the seven dwarfs."],
    18: ["Unit 18: Means of transport", "I want to visit Dragon Bridge. I can get there by bus or by bike. It is very beautiful."],
    19: ["Unit 19: Places of interest", "I think Hoi An Old Town is peaceful. It is about twenty-nine kilometres from Da Nang."],
    20: ["Unit 20: Summer holidays", "This summer, I am going to visit Phong Nha Cave. I am going to go camping."]
};

// Kh·ªüi t·∫°o danh s√°ch
const unitSel = document.getElementById("unitSel");
for(let i=1; i<=20; i++) {
    unitSel.innerHTML += `<option value="${i}">Unit ${i}</option>`;
}

function updateUnit() {
    const data = units[unitSel.value];
    document.getElementById("unitTitle").innerText = data[0];
    document.getElementById("sampleText").innerText = data[1];
    document.getElementById("feedbackCard").style.display = "none";
}
updateUnit();

// --- H√ÄM NGHE: S·ª¨A L·ªñI TR√äN ƒêI·ªÜN THO·∫†I ---
function speakNow(text) {
    if(!text) return;
    window.speechSynthesis.cancel(); // Reset TTS
    const msg = new SpeechSynthesisUtterance(text);
    msg.lang = 'en-US';
    msg.rate = 0.8;
    msg.pitch = 1.1;
    window.speechSynthesis.speak(msg);
}

// --- NH·∫¨N DI·ªÜN GI·ªåNG N√ìI ---
let recognition;
let isRec = false;

function toggleRec() {
    // M·ªìi √¢m thanh ƒë·ªÉ iOS cho ph√©p
    speakNow(" "); 
    
    if(!recognition) {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SR();
        recognition.lang = 'en-US';
        recognition.onresult = e => {
            const said = e.results[0][0].transcript;
            document.getElementById("studentText").value = said;
            analyzeSpeech(said);
        };
        recognition.onend = () => {
            isRec = false;
            document.getElementById("recBtn").innerText = "üéô START SPEAKING";
            document.getElementById("recBtn").classList.remove("recording");
        };
    }

    if(isRec) {
        recognition.stop();
    } else {
        recognition.start();
        isRec = true;
        document.getElementById("recBtn").innerText = "üõë STOP & CHECK";
        document.getElementById("recBtn").classList.add("recording");
    }
}

// --- AI PH√ÇN T√çCH V√Ä S·ª¨A L·ªñI ---
function analyzeSpeech(said) {
    const mode = document.getElementById("mode").value;
    const fbCard = document.getElementById("feedbackCard");
    const wordFb = document.getElementById("wordFeedback");
    const gramFb = document.getElementById("grammarFeedback");
    fbCard.style.display = "block";
    
    // 1. Ph√¢n t√≠ch t·ª´ng t·ª´ (ƒê√∫ng Xanh - Sai Cam)
    const sample = document.getElementById("sampleText").innerText;
    const sampleWords = sample.split(" ");
    const saidLower = said.toLowerCase();
    let html = "";
    let correctCount = 0;

    sampleWords.forEach(word => {
        let clean = word.toLowerCase().replace(/[.,!]/g,"");
        if(saidLower.includes(clean)) {
            html += `<span class="word-correct" onclick="speakNow('${clean}')">${word} </span>`;
            correctCount++;
        } else {
            html += `<span class="word-error" onclick="speakNow('${clean}')">${word} </span>`;
        }
    });
    wordFb.innerHTML = `<p><b>Pronunciation:</b><br>${html}</p><small>(Tap words to hear sample)</small>`;

    // 2. S·ª≠a l·ªói ng·ªØ ph√°p (AI Teacher Suggestion)
    let fix = said.toLowerCase()
        .replace(/\bi like swim\b/g, "I like swimming")
        .replace(/\bshe go\b/g, "she goes")
        .replace(/\bhe go\b/g, "he goes")
        .replace(/\bi live countryside\b/g, "I live in the countryside")
        .replace(/\byou like to be\b/g, "I'd like to be")
        .replace(/\bi is\b/g, "I am");
    
    fix = fix.charAt(0).toUpperCase() + fix.slice(1);
    
    if(fix.toLowerCase() !== said.toLowerCase()) {
        gramFb.innerHTML = `<div class="grammar-fix"><b>üí° AI Teacher Suggest:</b><br>"${fix}"</div>`;
    } else {
        gramFb.innerHTML = "";
    }

    // 3. Ch·∫•m sao v√† hi·ªán Gi·∫•y khen
    let stars = (correctCount / sampleWords.length) > 0.7 ? 5 : (correctCount / sampleWords.length) > 0.4 ? 4 : 3;
    document.getElementById("starBox").innerText = "‚≠ê".repeat(stars);
    document.getElementById("clap").play();
    showCert(stars);
}

function showCert(stars) {
    const cert = document.getElementById("certificate");
    cert.style.display = "block";
    document.getElementById("cName").innerText = document.getElementById("studentName").value || "Super Star";
    document.getElementById("cClassAndUnit").innerText = "Class: " + (document.getElementById("studentClass").value || "5/...") + " | " + units[unitSel.value][0];
    document.getElementById("cStar").innerText = "‚≠ê".repeat(stars);
    cert.scrollIntoView({behavior: 'smooth'});
}
</script>
</body>
</html>
